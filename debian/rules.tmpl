#!/usr/bin/make -f
# -*- mode:makefile -*-
##### Author: Travis Cross <tc@traviscross.com>

#export DH_VERBOSE=1

#### vars

DESTDIR ?= debian/tmp/usr/share/freeswitch/sounds
spath := __PATH__
srate := __RATE__
ver := __VERSION__
pkg := __PKG_NAME__
rates := 48000

all: binary

#### build sounds

dirs := $(wildcard $(spath)/*)
sdirs := $(addsuffix /$(srate), $(dirs))
ddirs := $(addprefix $(DESTDIR)/,$(foreach rate,$(rates),$(addsuffix /$(rate), $(dirs))))
sfiles := $(foreach dir,$(sdirs),$(wildcard $(dir)/*.wav))
dfiles := $(addprefix $(DESTDIR)/,$(foreach rate,$(rates),$(subst /$(srate)/,/$(rate)/,$(sfiles))))

define defdir
$(DESTDIR)/$(spath)/%/$(1): $(spath)/%/$(srate)
	mkdir -p $$@
endef

define deffile
$(DESTDIR)/$(subst /$(srate)/,/$(2)/,$(1)): $(1) $(DESTDIR)/$(dir $(subst /$(srate)/,/$(2)/,$(1)))
	sox $$< -r$(2) $$@
endef

$(foreach rate,$(rates),$(eval $(call defdir,$(rate))))
$(foreach rate,$(rates),$(foreach snd,$(sfiles),$(eval $(call deffile,$(snd),$(rate)))))

#### debian

binary: binary-indep
binary-arch:
binary-indep: build-indep
	dh_testdir -i
	dh_testroot -i
	dh_installdirs -i
	dh_install -i
	dh_installdocs -i
	dh_installchangelogs -i
	dh_lintian -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

build: build-indep
build-arch:
build-indep: $(dfiles)

get-orig-source:
	$(eval tmpdir := $(shell mktemp -d --tmpdir=.))
	wget -O $(tmpdir)/upstream.tgz "http://files.freeswitch.org/$(pkg)-$(srate)-$(ver).tar.gz"
	mkdir -p $(tmpdir)/$(pkg)-$(ver)
	tar -x -C $(tmpdir)/$(pkg)-$(ver) -f $(tmpdir)/upstream.tgz
	tar -c -C $(tmpdir) -f $(pkg)_$(ver).orig.tar $(pkg)-$(ver)
	xz -9ev $(pkg)_$(ver).orig.tar
	rm -rf $(tmpdir)

clean:
	dh_testdir
	dh_clean

